(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(require('@angular/core'),exports, require('@angular/core'), require('rxjs'), require('pica/dist/pica'), require('exifr/dist/mini.legacy.umd')) :
	typeof define === 'function' && define.amd ? define(['@angular/core','exports', '@angular/core', 'rxjs', 'pica/dist/pica', 'exifr/dist/mini.legacy.umd'], factory) :
	(factory(global.ng.core,(global['ng2-pica'] = global['ng2-pica'] || {}),global.ng.core,global.Rx,global.pica,global.exifr));
}(this, (function (ɵngcc0,exports,_angular_core,rxjs,pica,exifr) { 'use strict';

pica = 'default' in pica ? pica['default'] : pica;

var ImgExifService = /** @class */ (function () {
    function ImgExifService() {
    }
    ImgExifService.prototype.getOrientedImage = function (image) {
        return new Promise(function (resolve) {
            var img;
            exifr.orientation(image).catch(function (err) { return undefined; }).then(function (orientation$$1) {
                if (orientation$$1 != 1) {
                    var canvas = document.createElement("canvas"), ctx = canvas.getContext("2d"), cw = image.width, ch = image.height, cx = 0, cy = 0, deg = 0;
                    switch (orientation$$1) {
                        case 3:
                        case 4:
                            cx = -image.width;
                            cy = -image.height;
                            deg = 180;
                            break;
                        case 5:
                        case 6:
                            cw = image.height;
                            ch = image.width;
                            cy = -image.height;
                            deg = 90;
                            break;
                        case 7:
                        case 8:
                            cw = image.height;
                            ch = image.width;
                            cx = -image.width;
                            deg = 270;
                            break;
                        default:
                            break;
                    }
                    canvas.width = cw;
                    canvas.height = ch;
                    if ([2, 4, 5, 7].indexOf(orientation$$1) > -1) {
                        //flip image
                        ctx.translate(cw, 0);
                        ctx.scale(-1, 1);
                    }
                    ctx.rotate(deg * Math.PI / 180);
                    ctx.drawImage(image, cx, cy);
                    img = document.createElement("img");
                    img.width = cw;
                    img.height = ch;
                    img.addEventListener('load', function () {
                        resolve(img);
                    });
                    img.src = canvas.toDataURL("image/png");
                }
                else {
                    resolve(image);
                }
            });
        });
    };
ImgExifService.ɵfac = function ImgExifService_Factory(t) { return new (t || ImgExifService)(); };
ImgExifService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: ImgExifService, factory: function (t) { return ImgExifService.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ImgExifService, [{
        type: _angular_core.Injectable
    }], function () { return []; }, null); })();
    return ImgExifService;
}());

var Ng2PicaService = /** @class */ (function () {
    function Ng2PicaService(imageExifService) {
        this.imageExifService = imageExifService;
    }
    Ng2PicaService.prototype.resize = function (files, width, height, keepAspectRatio) {
        if (keepAspectRatio === void 0) { keepAspectRatio = false; }
        var resizedFile = new rxjs.Subject();
        for (var i = 0; i < files.length; i++) {
            this.resizeFile(files[i], width, height, keepAspectRatio).then(function (returnedFile) {
                resizedFile.next(returnedFile);
            }).catch(function (error) {
                resizedFile.error(error);
            });
        }
        return resizedFile.asObservable();
    };
    Ng2PicaService.prototype.resizeCanvas = function (from, to, options) {
        var result = new Promise(function (resolve, reject) {
            var curPica = new pica();
            if (!curPica || !curPica.resize) {
                curPica = new window.pica();
            }
            curPica.resize(from, to, options)
                .then(function (response) {
                resolve(response);
            }, function (error) {
                reject(error);
            });
        });
        return result;
    };
    Ng2PicaService.prototype.resizeBuffer = function (options) {
        var result = new Promise(function (resolve, reject) {
            var curPica = new pica();
            if (!curPica || !curPica.resizeBuffer) {
                curPica = new window.pica();
            }
            curPica.resizeBuffer(options)
                .then(function (response) {
                resolve(response);
            }, function (error) {
                reject(error);
            });
        });
        return result;
    };
    Ng2PicaService.prototype.resizeFile = function (file, width, height, keepAspectRatio) {
        var _this = this;
        if (keepAspectRatio === void 0) { keepAspectRatio = false; }
        var result = new Promise(function (resolve, reject) {
            var fromCanvas = document.createElement('canvas');
            var ctx = fromCanvas.getContext('2d');
            var img = new Image();
            img.onload = function () {
                _this.imageExifService.getOrientedImage(img).then(function (orientedImg) {
                    window.URL.revokeObjectURL(img.src);
                    fromCanvas.width = orientedImg.width;
                    fromCanvas.height = orientedImg.height;
                    ctx.drawImage(orientedImg, 0, 0);
                    var imageData = ctx.getImageData(0, 0, orientedImg.width, orientedImg.height);
                    if (keepAspectRatio) {
                        var ratio = Math.min(width / imageData.width, height / imageData.height);
                        width = Math.round(imageData.width * ratio);
                        height = Math.round(imageData.height * ratio);
                    }
                    var useAlpha = true;
                    if (file.type === "image/jpeg" || (file.type === "image/png" && !_this.isImgUsingAlpha(imageData))) {
                        //image without alpha
                        useAlpha = false;
                        ctx = fromCanvas.getContext('2d', { 'alpha': false });
                        ctx.drawImage(orientedImg, 0, 0);
                    }
                    var toCanvas = document.createElement('canvas');
                    toCanvas.width = width;
                    toCanvas.height = height;
                    _this.resizeCanvas(fromCanvas, toCanvas, { 'alpha': useAlpha })
                        .then(function (resizedCanvas) {
                        resizedCanvas.toBlob(function (blob) {
                            var newFile = _this.generateResultFile(blob, file.name, file.type, new Date().getTime());
                            resolve(newFile);
                        }, file.type);
                    })
                        .catch(function (error) {
                        reject(error);
                    });
                });
            };
            img.src = window.URL.createObjectURL(file);
        });
        return result;
    };
    Ng2PicaService.prototype.isImgUsingAlpha = function (imageData) {
        for (var i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i + 3] !== 255) {
                return true;
            }
        }
        return false;
    };
    Ng2PicaService.prototype.generateResultFile = function (blob, name, type, lastModified) {
        var resultFile = new Blob([blob], { type: type });
        return this.blobToFile(resultFile, name, lastModified);
    };
    Ng2PicaService.prototype.blobToFile = function (blob, name, lastModified) {
        var file = blob;
        file.name = name;
        file.lastModified = lastModified;
        //Cast to a File() type
        return file;
    };
    /** @nocollapse */
    Ng2PicaService.ctorParameters = function () { return [
        { type: ImgExifService, decorators: [{ type: _angular_core.Inject, args: [_angular_core.forwardRef(function () { return ImgExifService; }),] }] }
    ]; };
Ng2PicaService.ɵfac = function Ng2PicaService_Factory(t) { return new (t || Ng2PicaService)(ɵngcc0.ɵɵinject(_angular_core.forwardRef(function () { return ImgExifService; }))); };
Ng2PicaService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: Ng2PicaService, factory: function (t) { return Ng2PicaService.ɵfac(t); } });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(Ng2PicaService, [{
        type: _angular_core.Injectable
    }], function () { return [{ type: ImgExifService, decorators: [{
                type: _angular_core.Inject,
                args: [_angular_core.forwardRef(function () { return ImgExifService; })]
            }] }]; }, null); })();
    return Ng2PicaService;
}());

var Ng2PicaModule = /** @class */ (function () {
    function Ng2PicaModule() {
    }
Ng2PicaModule.ɵmod = ɵngcc0.ɵɵdefineNgModule({ type: Ng2PicaModule });
Ng2PicaModule.ɵinj = ɵngcc0.ɵɵdefineInjector({ factory: function Ng2PicaModule_Factory(t) { return new (t || Ng2PicaModule)(); }, providers: [
        { provide: Ng2PicaService, useClass: Ng2PicaService },
        { provide: ImgExifService, useClass: ImgExifService }
    ] });
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(Ng2PicaModule, [{
        type: _angular_core.NgModule,
        args: [{
                providers: [
                    { provide: Ng2PicaService, useClass: Ng2PicaService },
                    { provide: ImgExifService, useClass: ImgExifService }
                ]
            }]
    }], function () { return []; }, null); })();
    return Ng2PicaModule;
}());

exports.Ng2PicaService = Ng2PicaService;
exports.Ng2PicaModule = Ng2PicaModule;
exports.ImgExifService = ImgExifService;

Object.defineProperty(exports, '__esModule', { value: true });

})));

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcyLXBpY2EudW1kLmpzIiwic291cmNlcyI6WyJuZzItcGljYS51bWQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQSxpR0FBd0U7QUFDeEUsc0VBQXNEO0FBQ3RELHlCQUFVO0FBQ1YsMEJBQW1CO0FBQ25CO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7Ozs7O2dEQUdNO0FBQ047QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxNQUdNO0FBQ047QUFDQTtBQUNBO0FBQ0E7Ozs7Ozs7O2tDQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7Ozs7Ozs7Ozs7OztnREFRTTtBQUNOO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHtcblx0dHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnICYmIHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnID8gZmFjdG9yeShleHBvcnRzLCByZXF1aXJlKCdAYW5ndWxhci9jb3JlJyksIHJlcXVpcmUoJ3J4anMnKSwgcmVxdWlyZSgncGljYS9kaXN0L3BpY2EnKSwgcmVxdWlyZSgnZXhpZnIvZGlzdC9taW5pLmxlZ2FjeS51bWQnKSkgOlxuXHR0eXBlb2YgZGVmaW5lID09PSAnZnVuY3Rpb24nICYmIGRlZmluZS5hbWQgPyBkZWZpbmUoWydleHBvcnRzJywgJ0Bhbmd1bGFyL2NvcmUnLCAncnhqcycsICdwaWNhL2Rpc3QvcGljYScsICdleGlmci9kaXN0L21pbmkubGVnYWN5LnVtZCddLCBmYWN0b3J5KSA6XG5cdChmYWN0b3J5KChnbG9iYWxbJ25nMi1waWNhJ10gPSBnbG9iYWxbJ25nMi1waWNhJ10gfHwge30pLGdsb2JhbC5uZy5jb3JlLGdsb2JhbC5SeCxnbG9iYWwucGljYSxnbG9iYWwuZXhpZnIpKTtcbn0odGhpcywgKGZ1bmN0aW9uIChleHBvcnRzLF9hbmd1bGFyX2NvcmUscnhqcyxwaWNhLGV4aWZyKSB7ICd1c2Ugc3RyaWN0JztcblxucGljYSA9ICdkZWZhdWx0JyBpbiBwaWNhID8gcGljYVsnZGVmYXVsdCddIDogcGljYTtcblxudmFyIEltZ0V4aWZTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gSW1nRXhpZlNlcnZpY2UoKSB7XHJcbiAgICB9XHJcbiAgICBJbWdFeGlmU2VydmljZS5wcm90b3R5cGUuZ2V0T3JpZW50ZWRJbWFnZSA9IGZ1bmN0aW9uIChpbWFnZSkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkge1xyXG4gICAgICAgICAgICB2YXIgaW1nO1xyXG4gICAgICAgICAgICBleGlmci5vcmllbnRhdGlvbihpbWFnZSkuY2F0Y2goZnVuY3Rpb24gKGVycikgeyByZXR1cm4gdW5kZWZpbmVkOyB9KS50aGVuKGZ1bmN0aW9uIChvcmllbnRhdGlvbiQkMSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG9yaWVudGF0aW9uJCQxICE9IDEpIHtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImNhbnZhc1wiKSwgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKSwgY3cgPSBpbWFnZS53aWR0aCwgY2ggPSBpbWFnZS5oZWlnaHQsIGN4ID0gMCwgY3kgPSAwLCBkZWcgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAob3JpZW50YXRpb24kJDEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAzOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjeCA9IC1pbWFnZS53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN5ID0gLWltYWdlLmhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZyA9IDE4MDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlIDU6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNjpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN3ID0gaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ggPSBpbWFnZS53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN5ID0gLWltYWdlLmhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlZyA9IDkwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgNzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSA4OlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3cgPSBpbWFnZS5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaCA9IGltYWdlLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3ggPSAtaW1hZ2Uud2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWcgPSAyNzA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjYW52YXMud2lkdGggPSBjdztcclxuICAgICAgICAgICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2g7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKFsyLCA0LCA1LCA3XS5pbmRleE9mKG9yaWVudGF0aW9uJCQxKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vZmxpcCBpbWFnZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHgudHJhbnNsYXRlKGN3LCAwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY3R4LnNjYWxlKC0xLCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY3R4LnJvdGF0ZShkZWcgKiBNYXRoLlBJIC8gMTgwKTtcclxuICAgICAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCBjeCwgY3kpO1xyXG4gICAgICAgICAgICAgICAgICAgIGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJpbWdcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgaW1nLndpZHRoID0gY3c7XHJcbiAgICAgICAgICAgICAgICAgICAgaW1nLmhlaWdodCA9IGNoO1xyXG4gICAgICAgICAgICAgICAgICAgIGltZy5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGltZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoXCJpbWFnZS9wbmdcIik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGltYWdlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG4gICAgSW1nRXhpZlNlcnZpY2UuZGVjb3JhdG9ycyA9IFtcclxuICAgICAgICB7IHR5cGU6IF9hbmd1bGFyX2NvcmUuSW5qZWN0YWJsZSB9LFxyXG4gICAgXTtcclxuICAgIHJldHVybiBJbWdFeGlmU2VydmljZTtcclxufSgpKTtcblxudmFyIE5nMlBpY2FTZXJ2aWNlID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xyXG4gICAgZnVuY3Rpb24gTmcyUGljYVNlcnZpY2UoaW1hZ2VFeGlmU2VydmljZSkge1xyXG4gICAgICAgIHRoaXMuaW1hZ2VFeGlmU2VydmljZSA9IGltYWdlRXhpZlNlcnZpY2U7XHJcbiAgICB9XHJcbiAgICBOZzJQaWNhU2VydmljZS5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24gKGZpbGVzLCB3aWR0aCwgaGVpZ2h0LCBrZWVwQXNwZWN0UmF0aW8pIHtcclxuICAgICAgICBpZiAoa2VlcEFzcGVjdFJhdGlvID09PSB2b2lkIDApIHsga2VlcEFzcGVjdFJhdGlvID0gZmFsc2U7IH1cclxuICAgICAgICB2YXIgcmVzaXplZEZpbGUgPSBuZXcgcnhqcy5TdWJqZWN0KCk7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB0aGlzLnJlc2l6ZUZpbGUoZmlsZXNbaV0sIHdpZHRoLCBoZWlnaHQsIGtlZXBBc3BlY3RSYXRpbykudGhlbihmdW5jdGlvbiAocmV0dXJuZWRGaWxlKSB7XHJcbiAgICAgICAgICAgICAgICByZXNpemVkRmlsZS5uZXh0KHJldHVybmVkRmlsZSk7XHJcbiAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgcmVzaXplZEZpbGUuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc2l6ZWRGaWxlLmFzT2JzZXJ2YWJsZSgpO1xyXG4gICAgfTtcclxuICAgIE5nMlBpY2FTZXJ2aWNlLnByb3RvdHlwZS5yZXNpemVDYW52YXMgPSBmdW5jdGlvbiAoZnJvbSwgdG8sIG9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICB2YXIgY3VyUGljYSA9IG5ldyBwaWNhKCk7XHJcbiAgICAgICAgICAgIGlmICghY3VyUGljYSB8fCAhY3VyUGljYS5yZXNpemUpIHtcclxuICAgICAgICAgICAgICAgIGN1clBpY2EgPSBuZXcgd2luZG93LnBpY2EoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjdXJQaWNhLnJlc2l6ZShmcm9tLCB0bywgb3B0aW9ucylcclxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xyXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH07XHJcbiAgICBOZzJQaWNhU2VydmljZS5wcm90b3R5cGUucmVzaXplQnVmZmVyID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcclxuICAgICAgICB2YXIgcmVzdWx0ID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xyXG4gICAgICAgICAgICB2YXIgY3VyUGljYSA9IG5ldyBwaWNhKCk7XHJcbiAgICAgICAgICAgIGlmICghY3VyUGljYSB8fCAhY3VyUGljYS5yZXNpemVCdWZmZXIpIHtcclxuICAgICAgICAgICAgICAgIGN1clBpY2EgPSBuZXcgd2luZG93LnBpY2EoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjdXJQaWNhLnJlc2l6ZUJ1ZmZlcihvcHRpb25zKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcclxuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfTtcclxuICAgIE5nMlBpY2FTZXJ2aWNlLnByb3RvdHlwZS5yZXNpemVGaWxlID0gZnVuY3Rpb24gKGZpbGUsIHdpZHRoLCBoZWlnaHQsIGtlZXBBc3BlY3RSYXRpbykge1xyXG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgICAgaWYgKGtlZXBBc3BlY3RSYXRpbyA9PT0gdm9pZCAwKSB7IGtlZXBBc3BlY3RSYXRpbyA9IGZhbHNlOyB9XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICAgICAgdmFyIGZyb21DYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcclxuICAgICAgICAgICAgdmFyIGN0eCA9IGZyb21DYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgICAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpO1xyXG4gICAgICAgICAgICBpbWcub25sb2FkID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgX3RoaXMuaW1hZ2VFeGlmU2VydmljZS5nZXRPcmllbnRlZEltYWdlKGltZykudGhlbihmdW5jdGlvbiAob3JpZW50ZWRJbWcpIHtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuVVJMLnJldm9rZU9iamVjdFVSTChpbWcuc3JjKTtcclxuICAgICAgICAgICAgICAgICAgICBmcm9tQ2FudmFzLndpZHRoID0gb3JpZW50ZWRJbWcud2lkdGg7XHJcbiAgICAgICAgICAgICAgICAgICAgZnJvbUNhbnZhcy5oZWlnaHQgPSBvcmllbnRlZEltZy5oZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZShvcmllbnRlZEltZywgMCwgMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlRGF0YSA9IGN0eC5nZXRJbWFnZURhdGEoMCwgMCwgb3JpZW50ZWRJbWcud2lkdGgsIG9yaWVudGVkSW1nLmhlaWdodCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtlZXBBc3BlY3RSYXRpbykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmF0aW8gPSBNYXRoLm1pbih3aWR0aCAvIGltYWdlRGF0YS53aWR0aCwgaGVpZ2h0IC8gaW1hZ2VEYXRhLmhlaWdodCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoID0gTWF0aC5yb3VuZChpbWFnZURhdGEud2lkdGggKiByYXRpbyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodCA9IE1hdGgucm91bmQoaW1hZ2VEYXRhLmhlaWdodCAqIHJhdGlvKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHVzZUFscGhhID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZS50eXBlID09PSBcImltYWdlL2pwZWdcIiB8fCAoZmlsZS50eXBlID09PSBcImltYWdlL3BuZ1wiICYmICFfdGhpcy5pc0ltZ1VzaW5nQWxwaGEoaW1hZ2VEYXRhKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy9pbWFnZSB3aXRob3V0IGFscGhhXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZUFscGhhID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGN0eCA9IGZyb21DYW52YXMuZ2V0Q29udGV4dCgnMmQnLCB7ICdhbHBoYSc6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjdHguZHJhd0ltYWdlKG9yaWVudGVkSW1nLCAwLCAwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9DYW52YXMud2lkdGggPSB3aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICB0b0NhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucmVzaXplQ2FudmFzKGZyb21DYW52YXMsIHRvQ2FudmFzLCB7ICdhbHBoYSc6IHVzZUFscGhhIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNpemVkQ2FudmFzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2l6ZWRDYW52YXMudG9CbG9iKGZ1bmN0aW9uIChibG9iKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RmlsZSA9IF90aGlzLmdlbmVyYXRlUmVzdWx0RmlsZShibG9iLCBmaWxlLm5hbWUsIGZpbGUudHlwZSwgbmV3IERhdGUoKS5nZXRUaW1lKCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShuZXdGaWxlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgZmlsZS50eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgaW1nLnNyYyA9IHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9O1xyXG4gICAgTmcyUGljYVNlcnZpY2UucHJvdG90eXBlLmlzSW1nVXNpbmdBbHBoYSA9IGZ1bmN0aW9uIChpbWFnZURhdGEpIHtcclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGltYWdlRGF0YS5kYXRhLmxlbmd0aDsgaSArPSA0KSB7XHJcbiAgICAgICAgICAgIGlmIChpbWFnZURhdGEuZGF0YVtpICsgM10gIT09IDI1NSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfTtcclxuICAgIE5nMlBpY2FTZXJ2aWNlLnByb3RvdHlwZS5nZW5lcmF0ZVJlc3VsdEZpbGUgPSBmdW5jdGlvbiAoYmxvYiwgbmFtZSwgdHlwZSwgbGFzdE1vZGlmaWVkKSB7XHJcbiAgICAgICAgdmFyIHJlc3VsdEZpbGUgPSBuZXcgQmxvYihbYmxvYl0sIHsgdHlwZTogdHlwZSB9KTtcclxuICAgICAgICByZXR1cm4gdGhpcy5ibG9iVG9GaWxlKHJlc3VsdEZpbGUsIG5hbWUsIGxhc3RNb2RpZmllZCk7XHJcbiAgICB9O1xyXG4gICAgTmcyUGljYVNlcnZpY2UucHJvdG90eXBlLmJsb2JUb0ZpbGUgPSBmdW5jdGlvbiAoYmxvYiwgbmFtZSwgbGFzdE1vZGlmaWVkKSB7XHJcbiAgICAgICAgdmFyIGZpbGUgPSBibG9iO1xyXG4gICAgICAgIGZpbGUubmFtZSA9IG5hbWU7XHJcbiAgICAgICAgZmlsZS5sYXN0TW9kaWZpZWQgPSBsYXN0TW9kaWZpZWQ7XHJcbiAgICAgICAgLy9DYXN0IHRvIGEgRmlsZSgpIHR5cGVcclxuICAgICAgICByZXR1cm4gZmlsZTtcclxuICAgIH07XHJcbiAgICBOZzJQaWNhU2VydmljZS5kZWNvcmF0b3JzID0gW1xyXG4gICAgICAgIHsgdHlwZTogX2FuZ3VsYXJfY29yZS5JbmplY3RhYmxlIH0sXHJcbiAgICBdO1xyXG4gICAgLyoqIEBub2NvbGxhcHNlICovXHJcbiAgICBOZzJQaWNhU2VydmljZS5jdG9yUGFyYW1ldGVycyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIFtcclxuICAgICAgICB7IHR5cGU6IEltZ0V4aWZTZXJ2aWNlLCBkZWNvcmF0b3JzOiBbeyB0eXBlOiBfYW5ndWxhcl9jb3JlLkluamVjdCwgYXJnczogW19hbmd1bGFyX2NvcmUuZm9yd2FyZFJlZihmdW5jdGlvbiAoKSB7IHJldHVybiBJbWdFeGlmU2VydmljZTsgfSksXSB9XSB9XHJcbiAgICBdOyB9O1xyXG4gICAgcmV0dXJuIE5nMlBpY2FTZXJ2aWNlO1xyXG59KCkpO1xuXG52YXIgTmcyUGljYU1vZHVsZSA9IC8qKiBAY2xhc3MgKi8gKGZ1bmN0aW9uICgpIHtcclxuICAgIGZ1bmN0aW9uIE5nMlBpY2FNb2R1bGUoKSB7XHJcbiAgICB9XHJcbiAgICBOZzJQaWNhTW9kdWxlLmRlY29yYXRvcnMgPSBbXHJcbiAgICAgICAgeyB0eXBlOiBfYW5ndWxhcl9jb3JlLk5nTW9kdWxlLCBhcmdzOiBbe1xyXG4gICAgICAgICAgICAgICAgICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB7IHByb3ZpZGU6IE5nMlBpY2FTZXJ2aWNlLCB1c2VDbGFzczogTmcyUGljYVNlcnZpY2UgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgeyBwcm92aWRlOiBJbWdFeGlmU2VydmljZSwgdXNlQ2xhc3M6IEltZ0V4aWZTZXJ2aWNlIH1cclxuICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICB9LF0gfSxcclxuICAgIF07XHJcbiAgICByZXR1cm4gTmcyUGljYU1vZHVsZTtcclxufSgpKTtcblxuZXhwb3J0cy5OZzJQaWNhU2VydmljZSA9IE5nMlBpY2FTZXJ2aWNlO1xuZXhwb3J0cy5OZzJQaWNhTW9kdWxlID0gTmcyUGljYU1vZHVsZTtcbmV4cG9ydHMuSW1nRXhpZlNlcnZpY2UgPSBJbWdFeGlmU2VydmljZTtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICdfX2VzTW9kdWxlJywgeyB2YWx1ZTogdHJ1ZSB9KTtcblxufSkpKTtcbiJdfQ==